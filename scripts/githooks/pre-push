#!/usr/bin/env pwsh
<#
.SYNOPSIS
    Git pre-commit hook to scan staged content using TruffleHog.

.DESCRIPTION
    - Imports shared logging utility
    - Uses shared TruffleHog module to scan staged diffs
    - Blocks commit if secrets are found
#>

$ErrorActionPreference = 'Stop'

# Get repo root
$repoRoot = Resolve-Path "$PSScriptRoot\..\.."

# Import LoggingUtils
$logPath = Join-Path -Path $repoRoot -ChildPath "scripts\LoggingUtils.psm1"
Import-Module $logPath -ErrorAction Stop

# Import TruffleHogShared
$modulePath = Join-Path -Path $PSScriptRoot -ChildPath "TruffleHogShared.psm1"
Import-Module $modulePath -ErrorAction Stop

Write-Log "üîç Running TruffleHog scan before commit..." -Type "info"

# Get staged file contents
$diff = Get-GitDiffContent -DiffType "cached"
$files = $diff.Files
$getContent = $diff.GetContent

if (-not $files -or $files.Count -eq 0) {
    Write-Log "üí§ No staged files to scan. Skipping TruffleHog." -Type "info"
    exit 0
}

$logDir = Initialize-TruffleHogLogDir
$hadSecrets = $false

foreach ($file in $files) {
    if (Test-FileHasMeaningfulContent $file) {
        $content = & $getContent.Invoke($file)
        $result